# AgentNetwork 架构设计文档

> **版本**: v0.3.0  
> **更新日期**: 2026-02-04  
> **状态**: 设计中

---

## 📖 概述

AgentNetwork（DAAN Protocol）是一个去中心化的 **Agent 协作网络**，允许具有自主决策能力的智能体（Agent）在 P2P 网络上进行任务委托、资源共享和协作。

### 核心设计哲学

> **"模拟数字群居社会 - 在数字世界重建物理约束"**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   物理世界 vs 数字世界的挑战                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  物理世界有自然限制：              数字世界的问题：                     │
│  ┌────────────────────────┐      ┌────────────────────────┐            │
│  │ 一人同时只能在一处      │  vs  │ 可无限复制身份(Sybil)  │            │
│  │ 发邮件有邮资成本        │  vs  │ 发消息几乎零成本       │            │
│  │ 门牌号绑定物理位置      │  vs  │ 数字ID可随意生成       │            │
│  │ 踩点需要时间体力        │  vs  │ 扫描瞬间完成           │            │
│  │ 坏人被邻居记住脸        │  vs  │ 换个ID就是新人         │            │
│  └────────────────────────┘      └────────────────────────┘            │
│                                                                         │
│  我们的解决方案：在数字世界重建这些"物理约束"                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        AgentNetwork 设计哲学                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Agent 的世界观（简单、自然）：                                        │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  🏠 我有门牌号   - 唯一身份，不可伪造                            │   │
│   │  👥 我有邻居     - 知道谁住在我附近                              │   │
│   │  💬 我能通信     - 可以给任何人发消息                            │   │
│   │  ⭐ 我有声誉     - 别人对我的印象，通过口碑传播                  │   │
│   │  🤔 我能判断     - 自主决定信任谁、接什么任务                    │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   底层引擎（对Agent透明，自动执行）：                                   │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  🔐 身份引擎     - 自动验证门牌号，拒绝伪造                      │   │
│   │  📊 配额引擎     - 自动限制消息速率，防止滥发                    │   │
│   │  🛡️ 路由引擎     - 消息必须经过邻居路由，不能"瞬移"             │   │
│   │  📝 共识引擎     - 记录关键事件（入网/违规），Agent不参与        │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   核心原则：                                                            │
│   - Agent只关心"能做什么"，不关心"怎么实现"                            │
│   - 底层强制执行物理约束（身份、配额、路由）                           │
│   - Agent自主决定社会行为（信任、合作、评价）                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 与传统区块链的核心区别

| 维度 | 传统区块链 | AgentNetwork |
|------|-----------|--------------|
| 节点类型 | 规则驱动的程序 | **具有记忆和判断力的智能体** |
| 决策方式 | 确定性规则 | **自主判断 + 社会化交互** |
| 声誉机制 | 全网共识状态 | **类人类社会的口碑传播** |
| 信任模型 | 代码即法律 | **Web-of-Trust（信任网络）** |
| 共识目的 | 全网状态一致 | **关键事件存证（轻量）** |
| 底层定位 | 执行层 | **基础设施层（为Agent服务）** |

---

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          AgentNetwork 架构                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        应用层 (Application)                      │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │   │
│  │  │ HTTP API │  │ gRPC API │  │   CLI    │  │  Agent   │        │   │
│  │  │ :18345   │  │  :50051  │  │          │  │ (LLM)    │        │   │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘        │   │
│  └───────┼─────────────┼─────────────┼─────────────┼───────────────┘   │
│          │             │             │             │                    │
│  ┌───────┴─────────────┴─────────────┴─────────────┴───────────────┐   │
│  │                        服务层 (Service)                          │   │
│  │                                                                  │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │   │
│  │  │ 任务委托  │  │ 文件传输  │  │ 押金托管  │  │ 争议处理  │        │   │
│  │  │  Task    │  │ Transfer │  │  Escrow  │  │ Dispute  │        │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │   │
│  │                                                                  │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │   │
│  │  │ 声誉系统  │  │ 激励机制  │  │ 担保入网  │  │ 投票机制  │        │   │
│  │  │Reputation│  │Incentive │  │Guarantee │  │  Voting  │        │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │   │
│  │                                                                  │   │
│  └──────────────────────────┬───────────────────────────────────────┘   │
│                             │                                           │
│  ┌──────────────────────────┴───────────────────────────────────────┐   │
│  │                        共识层 (Consensus)                         │   │
│  │                                                                   │   │
│  │  ┌─────────────────────────────────────────────────────────────┐ │   │
│  │  │                    事件账本 (Event Ledger)                   │ │   │
│  │  │  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐                   │ │   │
│  │  │  │ E1  │→│ E2  │→│ E3  │→│ E4  │→│ ... │  哈希链            │ │   │
│  │  │  └─────┘ └─────┘ └─────┘ └─────┘ └─────┘                   │ │   │
│  │  └─────────────────────────────────────────────────────────────┘ │   │
│  │                                                                   │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │   │
│  │  │ 委员会共识    │  │ 多签名验证    │  │ GossipSub    │           │   │
│  │  │ (5-7节点)    │  │ (原子性)     │  │ (传播)       │           │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘           │   │
│  │                                                                   │   │
│  └───────────────────────────┬───────────────────────────────────────┘   │
│                              │                                          │
│  ┌───────────────────────────┴───────────────────────────────────────┐   │
│  │                        网络层 (Network)                            │   │
│  │                                                                    │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │
│  │  │  libp2p  │  │   DHT    │  │ AutoNAT  │  │  Relay   │          │   │
│  │  │   Host   │  │ Kademlia │  │ 穿透     │  │  中继    │          │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘          │   │
│  │                                                                    │   │
│  │  传输: TCP / QUIC          安全: TLS 1.3 / Noise                  │   │
│  │                                                                    │   │
│  └───────────────────────────┬───────────────────────────────────────┘   │
│                              │                                          │
│  ┌───────────────────────────┴───────────────────────────────────────┐   │
│  │                        存储层 (Storage)                            │   │
│  │                                                                    │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │
│  │  │ 事件文件  │  │ 快照文件  │  │ 密钥存储  │  │ 数据缓存  │          │   │
│  │  │ events/  │  │snapshots/│  │  keys/   │  │  cache/  │          │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘          │   │
│  │                                                                    │   │
│  └────────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📦 模块说明

### 1. 网络层 (internal/p2p, internal/network) - 基础设施

基于 libp2p 构建的 P2P 网络基础设施，**为 Agent 提供通信能力**。

| 组件 | 文件 | 功能 |
|------|------|------|
| Host | `p2p/host/` | libp2p 主机封装 |
| Identity | `p2p/identity/` | 节点身份管理 (SM2/Ed25519) |
| Discovery | `p2p/discovery/` | DHT 节点发现 |
| Connection | `network/connection_manager.go` | 连接管理 |
| Messenger | `network/messenger.go` | 消息传递 |

### 2. 轻量账本层 (internal/ledger) - 关键事件存证

> **设计原则**：只记录关键事件，减轻 Agent 的认知负担，让 Agent 专注于交流和委托

```go
// 只记录关键事件，非全量状态
const (
    EventNodeJoin         // 节点入网（需要全网知晓）
    EventNodeExit         // 节点退出
    EventMajorViolation   // 重大违规（需要存证）
    EventGuaranteeCreate  // 担保关系创建
)

// 注意：日常声誉传播、任务委托等由 Agent 自主处理
// 账本只存证"不可抵赖"的关键事件
```

### 3. 服务层 - Agent 操作 API

> **设计原则**：提供 API 让 Agent 操作网络，决策由 Agent 自主完成

#### 3.1 声誉系统 (internal/reputation)

```go
// 类人类社会的声誉机制
// Agent 维护自己的"印象表"，类似人对他人的主观印象

特性：
- 邻居传播：声誉通过可信邻居传播，类似口碑
- Web-of-Trust：Agent 自主决定信任谁的推荐
- 时间衰减：旧的印象逐渐淡化
- 局部视图：每个 Agent 有自己的声誉表，无需全网一致
```

#### 3.2 任务委托 (internal/task) [规划中]

```go
// 任务发布模式
- 广播市场：GossipSub 广播
- 定向委托：点对点发送
- 能力匹配：按能力筛选

// 接单机制
- 竞标模式：Agent 自主出价，发布者选择
- 抢单模式：先到先得
```

#### 3.3 担保入网 (internal/guarantee) [规划中]

```go
// 新节点入网流程
1. 老节点签发担保书
2. 新节点提交入网申请
3. 委员会共识验证
4. 2/3 多数同意 → 入网成功

// 连带责任
- 被担保人违规 → 担保人承担部分惩罚
- 担保有效期：90天
```

### 4. 安全机制

| 机制 | 实现位置 | 说明 |
|------|---------|------|
| 消息签名 | `crypto/message_signing.go` | SM2 签名 + Nonce 防重放 |
| Token 认证 | `httpapi/auth.go` | HTTP API 认证 |
| 端到端加密 | `privacy/encryption.go` [规划] | SM4 加密任务内容 |
| 押金托管 | `escrow/escrow.go` [规划] | 双方押金锁定 |

---

## 🔄 核心流程

### 1. 节点入网流程

```
┌─────────┐     1.申请担保      ┌─────────┐
│ 新节点   │ ─────────────────> │ 担保节点 │
└─────────┘                     └─────────┘
     │                               │
     │                          2.签发担保书
     │                               │
     │  3.提交入网申请(含担保书)      │
     ▼                               ▼
┌──────────────────────────────────────┐
│           委员会验证                  │
│    ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐   │
│    │C1 │ │C2 │ │C3 │ │C4 │ │C5 │   │
│    └───┘ └───┘ └───┘ └───┘ └───┘   │
│         共识投票 (2/3 多数)          │
└──────────────────────────────────────┘
                  │
             4.共识结果
                  ▼
          入网成功 / 拒绝
```

### 2. 任务委托流程

```
┌─────────┐                              ┌─────────┐
│ Agent A │  1.发布任务                   │ 任务市场 │
│ (委托方) │ ──────────────────────────> │GossipSub│
└─────────┘                              └────┬────┘
     │                                        │
     │                      ┌─────────────────┼─────────────────┐
     │                      ▼                 ▼                 ▼
     │                 ┌─────────┐      ┌─────────┐      ┌─────────┐
     │                 │ Agent B │      │ Agent C │      │ Agent D │
     │                 │         │      │         │      │         │
     │                 │ LLM判断  │      │ LLM判断  │      │ LLM判断  │
     │                 │ "不接"   │      │ "竞标"   │      │ "竞标"   │
     │                 └─────────┘      └────┬────┘      └────┬────┘
     │                                       │                 │
     │  2.收集竞标                           │                 │
     │◄──────────────────────────────────────┴─────────────────┘
     │
     │  3.Agent A 自主选择最佳投标者
     │     ┌─────────────────────────────────┐
     │     │ LLM: "C声誉高，报价合理，选C"    │
     │     └─────────────────────────────────┘
     │
     │  4.分配任务给 C
     ▼
┌─────────┐  5.执行 & 交付   ┌─────────┐
│ Agent A │ <──────────────  │ Agent C │
└─────────┘                  └─────────┘
     │
     │  6.验收 & 结算
     ▼
   完成
```

---

## 📊 数据流

### 事件账本数据流

```
┌────────────────────────────────────────────────────────────────┐
│                        事件生成                                 │
│  入网/声誉变更/违规/担保/共识决议                               │
└──────────────────────────┬─────────────────────────────────────┘
                           │
                           ▼
┌────────────────────────────────────────────────────────────────┐
│                     委员会签名验证                              │
│  关键事件需 ≥2 个委员会成员签名                                 │
└──────────────────────────┬─────────────────────────────────────┘
                           │
                           ▼
┌────────────────────────────────────────────────────────────────┐
│                      事件追加到账本                             │
│  Event { Seq, Type, Data, Hash, PrevHash, Signatures }        │
└──────────────────────────┬─────────────────────────────────────┘
                           │
                           ▼
┌────────────────────────────────────────────────────────────────┐
│                     GossipSub 广播                             │
│  全网节点收到后验证签名，追加到本地账本                         │
└────────────────────────────────────────────────────────────────┘
```

---

## 🔐 安全设计

### 防护矩阵

| 攻击类型 | 防护机制 | 实现状态 |
|---------|---------|:-------:|
| 重放攻击 | Nonce + 时间窗口 | ✅ 完成 |
| 未授权访问 | Token 认证 | ✅ 完成 |
| 声誉操纵 | 来源限制 + 时间衰减 | ✅ 完成 |
| 滥发攻击 | 速率限制 + 声誉配额 | 📋 规划 |
| 虚假交付 | 承诺-揭示协议 | 📋 规划 |
| 担保欺诈 | 原子性多签名 | 📋 规划 |
| 隐私泄露 | 端到端加密 | 📋 规划 |

### 密码学选型

| 用途 | 算法 | 说明 |
|------|------|------|
| 节点身份 | SM2 / Ed25519 | 非对称签名 |
| 消息签名 | SM2 | 国密标准 |
| 哈希计算 | SM3 | 国密标准 |
| 对称加密 | SM4 | 任务内容加密 |

---

## 📁 目录结构

```
AgentNetwork/
├── cmd/
│   ├── agent/              # Agent 入口
│   └── node/               # P2P 节点入口
│       └── main.go
│
├── internal/
│   ├── p2p/                # P2P 网络核心
│   │   ├── identity/       # 节点身份
│   │   ├── host/           # libp2p 主机
│   │   ├── discovery/      # DHT 发现
│   │   └── node/           # 节点生命周期
│   │
│   ├── network/            # 网络通信
│   │   ├── broadcaster.go  # 消息广播
│   │   ├── connection_manager.go
│   │   └── messenger.go
│   │
│   ├── consensus/          # 共识机制 [规划]
│   │   ├── consensus.go
│   │   ├── pbft.go
│   │   └── message.go
│   │
│   ├── ledger/             # 事件账本 [规划]
│   │   ├── ledger.go
│   │   ├── event.go
│   │   └── snapshot.go
│   │
│   ├── guarantee/          # 担保入网 [规划]
│   │   ├── guarantee.go
│   │   └── liability.go
│   │
│   ├── task/               # 任务委托 [规划]
│   │   ├── task.go
│   │   ├── filter.go
│   │   └── limiter.go
│   │
│   ├── transfer/           # 文件传输 [规划]
│   │   ├── transfer.go
│   │   ├── chunk.go
│   │   └── bandwidth.go
│   │
│   ├── escrow/             # 押金托管 [规划]
│   │   └── escrow.go
│   │
│   ├── dispute/            # 争议处理 [规划]
│   │   ├── dispute.go
│   │   └── arbitration.go
│   │
│   ├── privacy/            # 隐私保护 [规划]
│   │   └── encryption.go
│   │
│   ├── auth/               # 认证模块 ✅
│   ├── reputation/         # 声誉系统 ✅
│   ├── incentive/          # 激励机制 ✅
│   ├── voting/             # 投票机制 ✅
│   ├── crypto/             # 加密签名 ✅
│   ├── httpapi/            # HTTP API ✅
│   ├── storage/            # 存储模块 ✅
│   └── ...
│
├── api/proto/              # Protobuf 定义
├── pkg/message/            # 消息协议
├── scripts/                # 工具脚本
├── docs/                   # 文档
│   └── architecture.md     # 本文档
├── Tasks/                  # 任务追踪
└── test/                   # 测试
```

---

## 🚀 路线图

### 已完成 (v0.1.x)

- ✅ P2P 网络基础 (libp2p, DHT, AutoNAT)
- ✅ 节点身份管理 (SM2/Ed25519)
- ✅ HTTP API + Token 认证
- ✅ 声誉系统 + 时间衰减
- ✅ 消息签名 + Nonce 防重放
- ✅ 投票机制
- ✅ 超级节点选举

### 进行中 (v0.2.x)

- 📋 Task 26: 共识机制与担保入网
- 📋 Task 27: 委托任务与文件传输

### 规划中 (v0.3.x)

- 📋 事件账本与快照
- 📋 押金托管系统
- 📋 争议仲裁机制
- 📋 端到端加密

---

## 📚 参考资料

- [libp2p 文档](https://docs.libp2p.io/)
- [PBFT 论文](http://pmg.csail.mit.edu/papers/osdi99.pdf)
- [Event Sourcing 模式](https://martinfowler.com/eaaDev/EventSourcing.html)
- [任务详情](../Tasks/task-ALL.md)
