# 🗂 节点信任与剔除设计方案

## 1️⃣ 信任来源

节点信任可以由三个维度建立：

1. **直接观察**

   * 节点自己的经历：任务完成情况、消息真实性、贡献量
   * 评分 → 信誉分 `r_direct`

2. **间接推荐（Web-of-Trust）**

   * 可信节点提供对其他节点的评价
   * 权重由与推荐者的信任程度决定
   * 评分 → `r_indirect = Σ(w_trust * r_from_trusted)`

3. **抵押 / 身份绑定**

   * 节点上线需 **SM2 公钥 + 信誉抵押**
   * 抵押降低伪造节点成本
   * 结合信誉分和贡献分管理权限

> 核心思想：信任不完全依赖于投票，而是综合评价（直接 + 间接 + 抵押）

---

## 2️⃣ 节点剔除机制（多数投票）

### 2.1 基础流程

1. 节点发起“投票剔除”请求
2. 邻近或可信节点收到请求 → 检查：

   * 是否有直接观察或间接推荐证明该节点异常
   * 投票权重 = 节点信誉分 + 抵押权重
3. 达到 **阈值多数同意** → 剔除节点（本地拒绝通信/任务）

### 2.2 权重投票公式（示例）

```
VoteWeight(node) = α * Reputation(node) + β * Stake(node)
```

* α, β 调节信誉与抵押的权重
* 投票累计：

```
Sum(VoteWeight_for) / Sum(VoteWeight_total) >= Threshold
```

* 例如 Threshold = 0.6 → 超过 60% 加权投票同意才剔除

### 2.3 多数投票特点

* **局部生效**：节点剔除首先在本地生效，经过邻居传播 → 网络逐步收敛
* **可撤回**：节点上次表现恢复好 → 可解除剔除状态

---

## 3️⃣ 防止恶意伪造节点（Sybil 攻击）

问题：攻击者快速生成大量节点操纵投票

### 3.1 解决思路

1. **节点身份绑定公钥**

   * 每个节点必须 SM2 公钥
   * 上线节点可绑定**信誉抵押 / 任务完成记录**

2. **新节点信誉初始化低**

   * 新节点默认信誉 = 0
   * 投票权重微弱 → 无法操纵剔除
   * 需要贡献任务 / 获取可信节点背书才能提升

3. **可信传播筛选**

   * 仅采纳可信节点推荐或投票
   * 新节点之间相互投票无效

4. **投票加权机制**

   * VoteWeight = Reputation + Stake
   * 高信誉节点投票有效
   * 新节点或攻击者节点权重低 → 无法形成恶意多数

5. **限制节点上线速度**（可选）

   * 限制单位时间内可加入网络节点数
   * 或要求完成初始任务才能获得投票权

---

## 4️⃣ 防止突发性投票操纵

* **缓冲期**：

  * 投票剔除需经过一段时间窗口（例如 10–30 分钟）
  * 防止瞬时大规模投票导致误伤
* **多次验证**：

  * 剔除请求需在不同时间点、多批节点确认
* **投票分层**：

  * 邻居投票 → 子网聚合 → 全网间接传播
  * 防止局部攻击影响全网

---

## 5️⃣ 工程落地策略

### 5.1 数据结构

```go
type NodeVote struct {
    TargetNodeID string
    VoterNodeID  string
    VoteWeight   float64
    Timestamp    time.Time
    Reason       string // optional
    Signature    []byte
}
```

```go
type NodeTrust struct {
    NodeID     string
    Reputation float64
    Stake      float64
    Status     string // Active / Suspended / Removed
}
```

### 5.2 投票流程

1. 发起投票 → 生成 `NodeVote`
2. 广播给邻居或可信节点
3. 节点验证投票签名 → 检查投票者信誉权重
4. 累计权重 → 达到 Threshold → 标记剔除
5. 传播剔除状态 → 网络逐步收敛

### 5.3 恢复流程

* 剔除节点可以通过：

  * 完成任务恢复信誉
  * 获得可信节点背书
* 自动解除剔除状态 → 保持网络动态自愈

---

## 6️⃣ 总结

| 问题       | 解决方案                       |
| -------- | -------------------------- |
| 节点作恶     | 任务失败/作假 → 直接减信誉、触发投票       |
| 多数投票剔除   | 信任 + 投票权重（信誉 + 抵押） + 阈值控制  |
| Sybil 攻击 | 新节点默认低信誉、抵押机制、投票权重低、加入速度限制 |
| 突发投票操纵   | 缓冲期、多轮确认、分层投票、防止局部操纵       |
| 网络自愈     | 节点恢复信誉或被背书 → 可解除剔除         |

> 核心思想：**结合信誉 + 抵押 + 投票 + 投票权重控制 + 窗口延迟**，实现多数投票剔除，同时防止大量伪造节点操纵网络。

---



* 节点投票
* 权重计算
* 阈值判断
* 剔除状态传播
* 恢复流程

---

## 🔗 架构对齐说明 (2026-02-04 v2)

> **参考**: [docs/architecture.md](../docs/architecture.md)
> 
> **核心理念**：投票机制模拟人类社会的民主决策，Agent自主参与投票判断

### ✅ 本设计与架构完全一致

| 设计点 | 说明 | 状态 |
|--------|------|:----:|
| **权重投票** | 高声誉/高抵押的Agent投票权重更大，类似社会中有信誉的人话语权更重 | ✅ 核心设计 |
| **多数阈值** | 类似民主投票的多数决 | ✅ 核心设计 |
| **局部生效→传播** | 投票结果从局部传播到全网，类似消息传播 | ✅ 核心设计 |
| **Web-of-Trust** | Agent自主决定信任谁的投票 | ✅ 核心设计 |
| **SM2签名** | 投票不可否认 | ✅ |

### 📋 设计理念

```
投票机制 = 模拟人类社会的民主决策

- 每个Agent有投票权
- 高声誉Agent权重更大（社会贤达）
- Agent自主判断是否参与投票
- 投票结果通过邻居传播收敛
- 超级节点 = 社区中的意见领袖（可选）

底层提供：投票消息传递、签名验证
Agent决定：是否投票、投什么票
```

### 📁 相关文件

- 现有实现: `internal/voting/voting.go`
- 底层支持: `internal/network/broadcaster.go`

