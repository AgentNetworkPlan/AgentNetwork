

# 🏘 邻居管理设计方案

## 1️⃣ 设计目标

1. **拓扑均衡**：避免孤岛和中心化节点
2. **可靠性**：保证节点在线、消息可达
3. **安全**：防止恶意节点接管邻居关系
4. **声誉传播优化**：邻居用于传播声誉和指责
5. **任务与消息中继**：离线节点消息可通过邻居中继
6. **动态维护**：节点上线/下线、加入/离开，邻居自动调整

---

## 2️⃣ 邻居类型

| 类型   | 作用           | 特征               |
| ---- | ------------ | ---------------- |
| 普通邻居 | 一般节点的直接邻居    | 传递消息、声誉、任务       |
| 超级邻居 | 超级节点作为邻居     | 审计、任务协调、中继、推荐新节点 |
| 中继邻居 | NAT/防火墙节点的中继 | 保障离线或受限节点通信      |

---

## 3️⃣ 邻居选择策略

1. **候选节点来源**：

   * 超级节点推荐
   * 已知节点列表（DHT/BT网络发现）
   * 邻居的邻居列表（推荐）

2. **选择原则**：

   * **声誉优先**：声誉 ≥ 阈值
   * **贡献优先**：任务完成率、指责正确率
   * **拓扑均衡**：避免重复连接同一节点
   * **地理/网络分布**（可选）：减少延迟

3. **邻居数量**：

   * 最小邻居数 = 3–5
   * 最大邻居数 = 10–15
   * 超过阈值 → 自动剔除低信誉或离线邻居

---

## 4️⃣ 邻居维护机制

| 功能     | 描述                         |
| ------ | -------------------------- |
| 心跳检测   | 定期 ping 邻居，记录在线状态          |
| 超时处理   | 连续 N 次心跳失败 → 标记为离线，更新邻居列表  |
| 动态调整   | 自动从候选列表添加新邻居，保持邻居数在阈值内     |
| 离线消息缓存 | 离线节点的消息/任务由邻居缓存中继          |
| 定期刷新   | 每 T 时间刷新邻居，防止网络分叉或恶意节点长期占据 |

---

## 5️⃣ 邻居安全策略

1. **资格检查**：

   * 声誉 ≥ 阈值
   * 在线时间 ≥ T
   * 邀请签名验证

2. **邻居更新控制**：

   * 限制频繁加入/剔除邻居
   * 防止恶意节点刷邻居或制造网络孤岛

3. **异常处理**：

   * 连续作恶/滥发声誉 → 邻居投票剔除
   * 超级节点监督邻居质量

---

## 6️⃣ 邻居的数据结构

```json
{
  "NeighborID": "NodeID_X",
  "PubKey": "SM2公钥",
  "Type": "普通/超级/中继",
  "Reputation": 12,
  "Contribution": 50,
  "LastSeen": 1670000000,
  "PingStatus": "Online/Offline",
  "TrustScore": 0.85,
  "InviteSignature": "SM2签名"
}
```

* **TrustScore**：可选，用于评价邻居可信度
* **LastSeen**：最后活跃时间
* **InviteSignature**：验证加入合法性

---

## 7️⃣ 邻居功能接口（HTTP/REST示例）

1. **获取邻居列表**

```http
GET /neighbors
Response:
[
  {NeighborID, Type, Reputation, LastSeen, TrustScore}
]
```

2. **添加邻居（接收邀请）**

```http
POST /neighbors/add
Body:
{
  "NeighborID": "NodeID_X",
  "PubKey": "...",
  "InviteSignature": "..."
}
```

3. **剔除邻居**

```http
POST /neighbors/remove
Body:
{
  "NeighborID": "NodeID_X",
  "Reason": "Offline/作恶",
  "Signature": "SM2签名(请求节点)"
}
```

4. **心跳/状态检查**

```http
POST /neighbors/ping
Body: { "NeighborID": "NodeID_X", "Timestamp": 1670000000, "Signature": "SM2签名" }
```

---

## 8️⃣ 声誉传播与邻居关系

* 声誉和指责**通过邻居传播**
* 邻居收到消息 → 验签 → 判断耐受值 → 更新本地声誉 → 向自己的邻居传播
* 传播衰减 + 耐受值限制 → 防止滥发

---

## 9️⃣ 总结

* 邻居是 **网络信息传播和任务执行的基础**
* 管理邻居需要兼顾：

  * **稳定性**：避免孤岛和频繁波动
  * **安全性**：防止恶意节点占据邻居位置
  * **声誉传播效率**：邻居是声誉和指责的主要传导路径
* **核心机制**：选择、维护、更新、验证、健康检查

---



1. 候选邻居生成
2. 邻居选择规则
3. 心跳与在线状态维护
4. 新邻居加入与离线处理
5. 声誉/指责消息通过邻居传播

