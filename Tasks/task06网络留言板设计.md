# 🗂 P2P 网络留言板设计方案（参考 BT + DHT）

## 1️⃣ 功能目标

* 节点可以**发布留言/公告**
* 节点可以**订阅或查询留言**
* 留言板去中心化 → 不依赖单一服务器
* 支持**短期消息存储**或**可选持久化**
* 留言可以**验证身份**（SM2 公钥签名）
* 可与**信誉系统**结合 → 优先显示高信誉节点留言

---

## 2️⃣ 设计思路参考 BT 网络

### 2.1 BT 网络启示

* **Tracker**：

  * 节点可以注册、查找种子
  * 集中式或去中心化 DHT（Mainline DHT）
* **DHT（Kademlia）**：

  * 每个节点维护局部路由表
  * 可以存储 key-value 对（节点ID → 地址 / metadata）
* **消息广播**：

  * BT 网络没有全局消息，但可以通过 DHT 或 gossip 传播短消息

> 核心思想：**通过 DHT 做去中心化寻址和存储，或者通过 gossip 协议做消息传播**

---

## 3️⃣ 留言板的节点架构

```
┌──────────────┐
│ 发布节点      │
│ (SM2身份)     │
└─────┬────────┘
      │ Publish Message
      ▼
┌──────────────┐
│ DHT / Gossip │
│ (存储/转发)  │
└─────┬────────┘
      │
      ▼
┌──────────────┐
│ 订阅节点      │
│ (查询/拉取)   │
└──────────────┘
```

### 节点角色

| 角色             | 描述                             |
| -------------- | ------------------------------ |
| 发布节点           | 发布留言，签名消息保证身份                  |
| DHT 节点 / Relay | 存储/转发留言，按 key-value 或 topic 分类 |
| 订阅节点           | 拉取或监听留言，验证签名                   |

---

## 4️⃣ 留言数据结构

```json
{
  "MessageID": "hash(发布者ID+时间+内容)",
  "Author": "SM2公钥",
  "Timestamp": 1670000000,
  "Content": "这是留言内容",
  "Signature": "SM2签名",
  "ReputationScore": 85
}
```

* **MessageID**：唯一标识，可做 DHT key
* **Author**：节点身份
* **Signature**：保证不可伪造
* **ReputationScore**（可选）：用于优先展示高信誉节点留言

---

## 5️⃣ 留言板寻址 / 存储策略

### 5.1 DHT 存储（参考 BT Mainline DHT）

* key = `hash(MessageID)`
* value = `Message` 内容（小尺寸，短消息）
* 通过 Kademlia 路由找到最近的节点存储
* 节点定期刷新存储（防止节点离线消息丢失）

### 5.2 Gossip / P2P 广播（可选）

* 发布节点将消息广播给邻居节点
* 邻居节点再次转发 → 最终大部分节点收到消息
* Gossip 可以结合 TTL（过期时间）限制消息传播

### 5.3 查询机制

1. **DHT 查询**：

   * 订阅节点按 MessageID / topic 查询
2. **广播监听**：

   * 订阅节点订阅特定 topic
   * 自动接收广播消息

---

## 6️⃣ 安全和防滥用

* **身份验证**：

  * 每条留言必须 SM2 签名
* **信誉加权**：

  * 留言可附加作者信誉分
  * 高信誉节点留言优先展示
* **防垃圾信息**：

  * 节点本地可过滤低信誉留言
  * Gossip / 广播可以限制消息 TTL
* **可撤回**：

  * 作者可用私钥签名撤回消息（可选）

---

## 7️⃣ 与声誉系统结合

* 节点发布留言 → 同时可作为贡献或活跃度指标
* 订阅节点获取留言 → 可更新本地信誉表
* 节点之间交换留言时也可以顺带交换**间接信誉信息**

---

## 8️⃣ 工程落地接口（Go + libp2p）

```go
// 发布留言
func PublishMessage(content string, topic string) error

// 查询留言
func QueryMessage(messageID string) (Message, error)

// 订阅 topic 留言
func SubscribeTopic(topic string, callback func(Message)) error

// 验证留言签名
func VerifyMessage(msg Message) bool
```

* **topic** 可以按任务类型、功能模块、群组等分类
* 消息可直接放入 gossip 或 DHT
* 消息订阅回调处理 → 智能体或工具直接消费

---

## 9️⃣ 总结

* 留言板无需全网账本，只需**去中心化存储/广播**
* 可以用 **DHT 存储短消息** 或 **Gossip 广播**
* SM2 签名保证身份，信誉分决定展示优先级
* 与声誉系统结合，可顺带传播信誉
* 支持动态节点上线/下线

> 核心参考：BT 网络的 **DHT + Tit-for-Tat** 机制 + gossip 消息传播 + Web-of-Trust 信任传播
