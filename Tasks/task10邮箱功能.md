æ˜ç™½äº†ï¼Œä½ æƒ³åœ¨ P2P ç½‘ç»œä¸­å®ç° **ç±»ä¼¼é‚®ç®±çš„åŠŸèƒ½**ï¼šèŠ‚ç‚¹å¯ä»¥ç»™å…¶ä»–èŠ‚ç‚¹å‘é€æ¶ˆæ¯ï¼Œæ¥æ”¶æ–¹å¯ä»¥éšæ—¶è·å–ï¼Œä¿è¯ **å»ä¸­å¿ƒåŒ– + å¯éªŒè¯ + æ”¯æŒç¦»çº¿/åœ¨çº¿**ã€‚æˆ‘å¸®ä½ æ¢³ç†ä¸€ä¸ªå¯è½åœ°è®¾è®¡æ–¹æ¡ˆï¼Œå‚è€ƒ P2P é‚®ç®±ã€BitTorrent DHTã€Matrix ç­‰å»ä¸­å¿ƒåŒ–æ¶ˆæ¯ç³»ç»Ÿã€‚

---

# ğŸ—‚ P2P èŠ‚ç‚¹é—´æ¶ˆæ¯ï¼ˆMailboxï¼‰è®¾è®¡æ–¹æ¡ˆ

## 1ï¸âƒ£ è®¾è®¡ç›®æ ‡

1. **ç‚¹å¯¹ç‚¹å‘é€**ï¼šèŠ‚ç‚¹å¯ä»¥ç›´æ¥ç»™å¦ä¸€ä¸ªèŠ‚ç‚¹å‘æ¶ˆæ¯
2. **æ”¯æŒç¦»çº¿èŠ‚ç‚¹**ï¼šæ¶ˆæ¯èƒ½å­˜å‚¨ç›´åˆ°æ¥æ”¶æ–¹ä¸Šçº¿
3. **æ¶ˆæ¯éªŒè¯**ï¼šä½¿ç”¨ SM2 ç­¾åï¼Œä¿è¯èº«ä»½ä¸å¯ä¼ªé€ 
4. **è½»é‡åŒ–å­˜å‚¨**ï¼šä¸ä¾èµ–å…¨ç½‘è´¦æœ¬
5. **å®‰å…¨ + éšç§**ï¼š

   * æ¶ˆæ¯å†…å®¹å¯åŠ å¯†ï¼ˆå¯é€‰ï¼Œä½¿ç”¨æ¥æ”¶æ–¹å…¬é’¥åŠ å¯†ï¼‰
   * ä»…æ¥æ”¶æ–¹èƒ½è¯»å–

---

## 2ï¸âƒ£ æ¶ˆæ¯æ•°æ®ç»“æ„

```json
{
  "MessageID": "hash(Sender+Receiver+Timestamp+Content)",
  "Sender": "SM2 å…¬é’¥",
  "Receiver": "SM2 å…¬é’¥",
  "Timestamp": 1670000000,
  "Content": "åŠ å¯†æˆ–æ˜æ–‡æ¶ˆæ¯",
  "Signature": "SM2ç­¾å(Senderå¯¹Content+Timestampç­¾å)",
  "Status": "pending"  // pending / delivered / read
}
```

* **MessageID**ï¼šå”¯ä¸€æ ‡è¯†æ¶ˆæ¯
* **Signature**ï¼šä¿è¯æ¶ˆæ¯ä¸å¯ç¯¡æ”¹
* **Status**ï¼šç”¨äºç¦»çº¿/åœ¨çº¿è¿½è¸ª

---

## 3ï¸âƒ£ æ¶ˆæ¯ä¼ è¾“æ–¹å¼

### 3.1 ç›´æ¥ P2P å‘é€ï¼ˆåœ¨çº¿èŠ‚ç‚¹ï¼‰

* å‘é€æ–¹ç›´æ¥é€šè¿‡ TCP/WebSocket/HTTP POST å°†æ¶ˆæ¯å‘é€ç»™æ¥æ”¶èŠ‚ç‚¹
* æ¥æ”¶èŠ‚ç‚¹éªŒè¯ç­¾å â†’ å­˜å‚¨æœ¬åœ°æˆ–ç›´æ¥äº¤ç»™ agent

**ä¼˜ç‚¹**ï¼šä½å»¶è¿Ÿï¼Œå®æ—¶é€šä¿¡
**ç¼ºç‚¹**ï¼šæ¥æ”¶æ–¹ç¦»çº¿æ—¶æ— æ³•ç«‹å³æŠ•é€’

---

### 3.2 ç¦»çº¿æ¶ˆæ¯å­˜å‚¨ï¼ˆä¸­ç»§èŠ‚ç‚¹/è¶…çº§èŠ‚ç‚¹ï¼‰

* ä½¿ç”¨ **è¶…çº§èŠ‚ç‚¹æˆ–å¯ä¿¡ä¸­ç»§èŠ‚ç‚¹** å­˜å‚¨ç¦»çº¿æ¶ˆæ¯
* æ¶ˆæ¯å­˜å‚¨ï¼š

  * key = Receiver NodeID
  * value = æ¶ˆæ¯åˆ—è¡¨ï¼ˆMessageID â†’ Messageï¼‰
* æ¥æ”¶æ–¹ä¸Šçº¿æ—¶ï¼š

  * æ‹‰å–æ¶ˆæ¯åˆ—è¡¨
  * éªŒè¯ç­¾å â†’ æ›´æ–°çŠ¶æ€ä¸º delivered

> ç±»ä¼¼é‚®ç®±ï¼šå‘é€æ–¹å‘å‡º â†’ ç½‘ç»œä¸­ç»§å­˜å‚¨ â†’ æ¥æ”¶æ–¹ä¸Šçº¿æ‹‰å–

---

### 3.3 å¯é€‰ï¼šåŠ å¯†ä¿æŠ¤

* ä½¿ç”¨æ¥æ”¶æ–¹ SM2 å…¬é’¥åŠ å¯†æ¶ˆæ¯å†…å®¹
* ä¿è¯å³ä½¿ä¸­ç»§èŠ‚ç‚¹å­˜å‚¨æ¶ˆæ¯ï¼Œä¹Ÿæ— æ³•è¯»å–å†…å®¹

---

## 4ï¸âƒ£ æ¥å£è®¾è®¡ï¼ˆHTTP/REST for agentï¼‰

### 4.1 å‘é€æ¶ˆæ¯

```http
POST /mail/send
Headers:
  X-NodeID: <Sender SM2 PubKey>
  X-Signature: <Signature of body>
Body:
{
  "Receiver": "<Receiver NodeID>",
  "Content": "Hello world",
  "Encrypted": true/false
}
Response:
{
  "MessageID": "<hash>",
  "Status": "queued"  // å·²æŠ•é€’ / å·²åŠ å…¥ä¸­ç»§
}
```

### 4.2 æ‹‰å–æ¶ˆæ¯ï¼ˆæ¥æ”¶æ–¹ agentï¼‰

```http
GET /mail/fetch
Headers:
  X-NodeID: <Receiver SM2 PubKey>
  X-Signature: <Signature of body>
Query Params:
  limit=10
Response:
[
  {
    "MessageID": "xxx",
    "Sender": "NodeID_A",
    "Content": "...",
    "Timestamp": 1670000000,
    "Signature": "...",
    "Status": "pending"
  }
]
```

### 4.3 æ›´æ–°æ¶ˆæ¯çŠ¶æ€

```http
POST /mail/read
Headers:
  X-NodeID: <Receiver SM2 PubKey>
  X-Signature: <Signature of body>
Body:
{
  "MessageID": "xxx"
}
Response:
{
  "Status": "ok"
}
```

---

## 5ï¸âƒ£ æ¶ˆæ¯å­˜å‚¨ç­–ç•¥

| ç±»å‹   | å­˜å‚¨ä½ç½®        | ä¿ç•™æ—¶é—´             | æè¿°           |
| ---- | ----------- | ---------------- | ------------ |
| åœ¨çº¿èŠ‚ç‚¹ | æœ¬åœ° agent    | æŒç»­               | å®æ—¶æ¥æ”¶ï¼Œä½å»¶è¿Ÿ     |
| ç¦»çº¿èŠ‚ç‚¹ | è¶…çº§èŠ‚ç‚¹ / ä¸­ç»§èŠ‚ç‚¹ | TTLï¼Œä¾‹å¦‚ 24h / 48h | å½“æ¥æ”¶èŠ‚ç‚¹ä¸Šçº¿æ‹‰å–ååˆ é™¤ |
| å†å²æ¶ˆæ¯ | å¯é€‰          | å¯ç”±èŠ‚ç‚¹è‡ªè¡Œå­˜æ¡£         | ä¾¿äºå®¡è®¡æˆ–æ—¥å¿—åˆ†æ    |

---

## 6ï¸âƒ£ é˜²æ»¥ç”¨ & å®‰å…¨

1. **èº«ä»½éªŒè¯**

   * æ‰€æœ‰æ¶ˆæ¯å¿…é¡» SM2 ç­¾å
   * æ¥æ”¶æ–¹å¯éªŒè¯å‘é€è€…èº«ä»½

2. **æŠ—åƒåœ¾æ¶ˆæ¯**

   * æ¶ˆæ¯å‘é€é¢‘ç‡é™åˆ¶
   * ä¿¡èª‰ä½èŠ‚ç‚¹å‘é€æ¶ˆæ¯é™åˆ¶ï¼ˆé˜²æ­¢æ¶æ„åˆ·å±ï¼‰

3. **é˜²ä¼ªé€ æŠ•ç¥¨/ä¸­ç»§æ”»å‡»**

   * ä¸­ç»§èŠ‚ç‚¹å­˜å‚¨æ—¶éªŒè¯ç­¾å
   * æ¶ˆæ¯åªå…è®¸æŒ‡å®š Receiver æ‹‰å–

4. **å¯é€‰åŠ å¯†**

   * å†…å®¹åŠ å¯† â†’ é˜²æ­¢ä¸­ç»§èŠ‚ç‚¹çª¥æ¢

---

## 7ï¸âƒ£ æ¶ˆæ¯æŠ•é€’æµç¨‹

```
Sender (åœ¨çº¿)
    â”‚
    â”œâ”€â”€> Receiver (åœ¨çº¿, P2P)
    â”‚       â”‚
    â”‚       â””â”€â”€ éªŒè¯ç­¾å â†’ Status=delivered
    â”‚
    â””â”€â”€> ä¸­ç»§/è¶…çº§èŠ‚ç‚¹ (æ¥æ”¶æ–¹ç¦»çº¿)
            â”‚
            â””â”€â”€ å­˜å‚¨æ¶ˆæ¯, TTL
Receiver ä¸Šçº¿
    â”‚
    â””â”€â”€ æ‹‰å–æ¶ˆæ¯åˆ—è¡¨ â†’ éªŒè¯ç­¾å â†’ Status=delivered
```

---

## 8ï¸âƒ£ ä¸ç°æœ‰ç³»ç»Ÿç»“åˆ

* **ä»»åŠ¡ç³»ç»Ÿ**ï¼šagent å¯ä»¥é€šè¿‡ mailbox æ¥æ”¶ä»»åŠ¡æˆ–ç»“æœ
* **å£°èª‰ç³»ç»Ÿ**ï¼šå‘é€/æ¥æ”¶æ¶ˆæ¯è¡Œä¸ºå¯åŠ åˆ†/æ‰£åˆ†
* **è¶…çº§èŠ‚ç‚¹**ï¼š

  * å¯ä»¥å®¡è®¡æ¶ˆæ¯ï¼ˆä¾‹å¦‚éªŒè¯å‘é€è€…èº«ä»½ï¼Œé˜²æ­¢ä¼ªé€ ï¼‰
  * ä¸å­˜å‚¨è§£å¯†å†…å®¹ï¼Œä¿è¯éšç§

---

âœ… **æ€»ç»“**

* èŠ‚ç‚¹é‚®ç®± = **ç‚¹å¯¹ç‚¹æ¶ˆæ¯ + ä¸­ç»§å­˜å‚¨ + SM2 ç­¾å + å¯é€‰åŠ å¯†**
* æ¶ˆæ¯æ”¯æŒåœ¨çº¿ç›´æŠ•å’Œç¦»çº¿å­˜å‚¨
* æ¥å£è®¾è®¡ç®€å•ï¼Œagent å¯ç›´æ¥ä½¿ç”¨ curl/HTTP è°ƒç”¨
* ä¸ä¿¡èª‰ã€ä»»åŠ¡ã€è¶…çº§èŠ‚ç‚¹å®¡è®¡ç³»ç»Ÿç»“åˆï¼Œæé«˜å®‰å…¨æ€§

---

* åœ¨çº¿æŠ•é€’
* ç¦»çº¿ä¸­ç»§å­˜å‚¨
* æ‹‰å–ä¸çŠ¶æ€æ›´æ–°
* ä¸è¶…çº§èŠ‚ç‚¹å®¡è®¡çš„äº¤äº’

