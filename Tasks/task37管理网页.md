# Task 37: WEB 管理平台

> **状态**: 📋 设计完成  
> **优先级**: P1  
> **依赖**: Task 09 (节点接口), Task 19 (端口设计)  
> **最后更新**: 2026-02-04

---

## 📋 原始需求

1. 技术使用 VUE
2. 可以管理节点和操作（查看 HTTP API 接口列表），方便我们直接在网页上管理和操作节点，也方便我们测试
3. 可以展示网络的拓扑图，并实时更新拓扑。我们希望可以在拓扑上查看节点的互联情况、共识情况，方便我们 DEBUG 和测试
4. 登录授权，通过 token 登录。可以提供一个登录页面或者弹窗，要求用户输入 token，token 在配置文件中，同时为了方便使用，命令行里面可以提供命令显示 token
5. 考虑到安全，支持使用命令行更新 token，重新生成一个 token
6. 修改节点启动功能，需要传入端口，我们现在有 3 个端口：外部的端口、内部给 agent 使用 http 端口、管理界面的端口

**附加需求**: 节点启动之后会显示一个网址，使用 GET 参数传输 token，然后网页打开之后直接认证。使用 cookie 保存会话的认证。

---

## 🎯 功能设计

### 1. 登录与认证

```
┌─────────────────────────────────────────────────────────────────┐
│                       认证流程                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  方式1: URL 参数认证（快速访问）                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  http://localhost:18080/admin?token=<admin_token>       │   │
│  │  → 自动验证 → 设置 Cookie → 跳转到仪表盘                 │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  方式2: 登录页面                                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  /login → 输入 Token → 验证 → Cookie → 仪表盘            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  Cookie 会话:                                                   │
│  - 名称: daan_session                                          │
│  - 有效期: 24 小时                                             │
│  - HttpOnly: true                                              │
│  - Secure: true (生产环境)                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2. 仪表盘 (Dashboard)

| 功能 | 说明 |
|------|------|
| 节点状态 | 在线状态、运行时间、版本信息 |
| 网络概览 | 连接数、消息吞吐量、带宽使用 |
| 快速操作 | 重启、停止、刷新状态 |
| 告警信息 | 异常连接、声誉变化、攻击检测 |

### 3. 网络拓扑图

```
┌─────────────────────────────────────────────────────────────────┐
│                     网络拓扑可视化                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  技术选型: ECharts (Graph 图)                                  │
│                                                                 │
│  节点显示:                                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  🟢 本节点      - 绿色圆圈，居中显示                      │   │
│  │  🔵 普通节点    - 蓝色圆圈，显示 NodeID 前8位             │   │
│  │  🟡 超级节点    - 金色五角星                              │   │
│  │  ⚪ 离线节点    - 灰色圆圈                                │   │
│  │  🔴 黑名单节点  - 红色圆圈                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  连接线:                                                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  ─── 直接连接    - 实线                                   │   │
│  │  --- 中继连接    - 虚线                                   │   │
│  │  粗细 = 消息频率                                          │   │
│  │  颜色 = 连接质量 (绿好/黄一般/红差)                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  交互功能:                                                      │
│  - 点击节点: 显示详细信息面板                                  │
│  - 悬停: 显示 NodeID、声誉、连接时间                           │
│  - 拖拽: 调整节点位置                                          │
│  - 缩放: 查看全局/局部                                         │
│  - 右键菜单: 断开连接、加入黑名单等操作                        │
│                                                                 │
│  实时更新:                                                      │
│  - WebSocket 连接，推送拓扑变化                                │
│  - 新节点加入/离开动画                                         │
│  - 连接建立/断开动画                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4. API 管理界面

```
┌─────────────────────────────────────────────────────────────────┐
│                     API 管理界面                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  API 列表 (类似 Swagger UI):                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  📁 节点管理                                              │   │
│  │    ├─ GET  /api/v1/node/info      获取节点信息           │   │
│  │    ├─ GET  /api/v1/node/peers     获取连接列表           │   │
│  │    └─ POST /api/v1/node/restart   重启节点               │   │
│  │  📁 消息通信                                              │   │
│  │    ├─ POST /api/v1/message/send   发送消息               │   │
│  │    └─ GET  /api/v1/message/list   获取消息列表           │   │
│  │  📁 声誉系统                                              │   │
│  │    ├─ GET  /api/v1/reputation/:id 查询声誉               │   │
│  │    └─ POST /api/v1/accusation     提交指责               │   │
│  │  ... (更多 API)                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  每个 API 展开显示:                                            │
│  - 请求参数表格                                                │
│  - 响应格式示例                                                │
│  - "Try it" 按钮 - 直接测试                                    │
│  - 请求/响应历史                                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5. 日志查看器

- 实时日志流（WebSocket）
- 日志级别过滤（DEBUG/INFO/WARN/ERROR）
- 关键字搜索
- 时间范围筛选
- 导出功能

### 6. 节点配置

| 配置项 | 说明 |
|--------|------|
| 基本信息 | NodeID、版本、数据目录 |
| 网络配置 | 监听地址、Bootstrap 节点 |
| 安全配置 | Token 管理、黑名单 |
| 日志配置 | 日志级别、保留天数 |

---

## 🏗️ 技术架构

### 前端技术栈

```
┌─────────────────────────────────────────────────────────────────┐
│                       前端技术栈                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  框架: Vue 3 + TypeScript + Vite                               │
│                                                                 │
│  UI 组件:                                                       │
│  - Element Plus (UI 组件库)                                    │
│  - ECharts (图表和拓扑图)                                      │
│  - Monaco Editor (JSON 编辑器，可选)                           │
│                                                                 │
│  状态管理: Pinia                                                │
│  路由: Vue Router                                               │
│  HTTP: Axios                                                    │
│  WebSocket: 原生 WebSocket                                      │
│                                                                 │
│  目录结构:                                                      │
│  web/admin/                                                     │
│  ├── src/                                                       │
│  │   ├── api/           # API 调用封装                         │
│  │   ├── components/    # 通用组件                             │
│  │   ├── views/         # 页面视图                             │
│  │   │   ├── Login.vue                                         │
│  │   │   ├── Dashboard.vue                                     │
│  │   │   ├── Topology.vue                                      │
│  │   │   ├── ApiExplorer.vue                                   │
│  │   │   ├── Logs.vue                                          │
│  │   │   └── Settings.vue                                      │
│  │   ├── stores/        # Pinia 状态                           │
│  │   ├── router/        # 路由配置                             │
│  │   └── utils/         # 工具函数                             │
│  ├── index.html                                                │
│  ├── vite.config.ts                                            │
│  └── package.json                                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 后端服务

```
┌─────────────────────────────────────────────────────────────────┐
│                       后端模块                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  新增模块: internal/webadmin/                                   │
│                                                                 │
│  webadmin/                                                      │
│  ├── server.go          # HTTP 服务器                          │
│  ├── auth.go            # Token 认证 + Session 管理            │
│  ├── handlers.go        # 管理接口处理                         │
│  ├── websocket.go       # WebSocket 支持                       │
│  ├── topology.go        # 拓扑数据生成                         │
│  └── static.go          # 静态文件服务 (embed)                 │
│                                                                 │
│  功能:                                                          │
│  - 提供管理专用 API (/admin/api/v1/*)                          │
│  - WebSocket 推送（拓扑、日志）                                │
│  - 静态文件服务（嵌入 Vue 构建产物）                           │
│  - Token 认证中间件                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔐 认证与安全

### Token 管理

```go
// 配置文件 config.json
{
  "admin": {
    "token": "auto-generated-uuid-token",
    "port": 18080,
    "bind": "127.0.0.1"  // 默认只监听本地
  }
}

// 命令行操作
agentnetwork token show      # 显示当前 admin token
agentnetwork token refresh   # 重新生成 token
```

### 节点启动显示

```
$ agentnetwork start

🚀 DAAN P2P Node v0.1.0 started
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  Node ID:    12D3KooWAbC...
  P2P:        /ip4/0.0.0.0/tcp/4001
  HTTP API:   http://127.0.0.1:18345
  Admin:      http://127.0.0.1:18080

  🔗 Quick Access (click to open):
     http://127.0.0.1:18080/admin?token=a1b2c3d4-e5f6-...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 🌐 端口规划

| 端口 | 用途 | 参数 | 默认值 | 绑定地址 |
|------|------|------|--------|----------|
| P2P 端口 | libp2p 网络通信 | `-listen` | `/ip4/0.0.0.0/tcp/0` | 0.0.0.0 |
| gRPC 端口 | 内部 gRPC 服务 | `-grpc` | `:50051` | 127.0.0.1 |
| HTTP API 端口 | Agent 调用的 HTTP API | `-http` | `:18345` | 127.0.0.1 |
| **Admin 端口** | **管理界面 (新增)** | `-admin` | `:18080` | 127.0.0.1 |

### 端口隔离策略

```
┌─────────────────────────────────────────────────────────────────┐
│                       端口隔离策略                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  外部网络 (Internet)                                            │
│      │                                                          │
│      └─── P2P 端口 (0.0.0.0:4001) ──── 节点间通信              │
│                                                                 │
│  ────────────────────────────────────────────────────────────── │
│      内网 / 本机 (127.0.0.1)                                    │
│                                                                 │
│      ├─── HTTP API (:18345) ──── Agent 调用                    │
│      │    └─ Token 认证 (api_token)                            │
│      │                                                          │
│      └─── Admin (:18080) ──── 管理界面                         │
│           └─ Token 认证 (admin_token)                          │
│                                                                 │
│  安全建议:                                                      │
│  - Admin 端口默认只监听 127.0.0.1                              │
│  - 如需远程管理，使用 SSH 隧道: ssh -L 18080:127.0.0.1:18080   │
│  - HTTP API 可按需开放给可信 Agent                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📡 WebSocket 接口

### 拓扑更新

```javascript
// 连接
ws = new WebSocket('ws://localhost:18080/admin/ws/topology');

// 接收消息格式
{
  "type": "topology_update",  // | "node_join" | "node_leave" | "edge_add" | "edge_remove"
  "data": {
    "nodes": [
      {"id": "12D3KooW...", "type": "self", "reputation": 0.85, "label": "本节点"},
      {"id": "12D3KooX...", "type": "peer", "reputation": 0.72, "label": "12D3KooX"}
    ],
    "edges": [
      {"source": "12D3KooW...", "target": "12D3KooX...", "type": "direct", "latency": 50}
    ]
  }
}
```

### 日志流

```javascript
// 连接 (可指定日志级别)
ws = new WebSocket('ws://localhost:18080/admin/ws/logs?level=INFO');

// 接收消息格式
{
  "type": "log",
  "timestamp": "2026-02-04T10:30:00Z",
  "level": "INFO",
  "module": "p2p",
  "message": "Connected to peer 12D3KooX..."
}
```

---

## 📁 文件结构

```
AgentNetwork/
├── cmd/node/main.go              # 新增 -admin 端口参数
├── internal/
│   ├── webadmin/                 # ★ 新增：管理界面后端
│   │   ├── server.go             # HTTP 服务器
│   │   ├── auth.go               # Token/Session 认证
│   │   ├── handlers.go           # API 处理器
│   │   ├── websocket.go          # WebSocket 处理
│   │   ├── topology.go           # 拓扑数据生成
│   │   └── embed.go              # 静态文件嵌入
│   └── config/config.go          # 新增 admin 配置
├── web/                          # ★ 新增：前端目录
│   └── admin/                    # Vue 管理界面
│       ├── src/
│       │   ├── api/
│       │   ├── components/
│       │   ├── views/
│       │   ├── stores/
│       │   ├── router/
│       │   └── App.vue
│       ├── public/
│       ├── package.json
│       ├── tsconfig.json
│       └── vite.config.ts
└── Makefile                      # 新增前端构建命令
```

---

## 🚀 实现计划

### Phase 1: 基础框架 (2 天)
- [ ] 创建 `internal/webadmin` 模块
- [ ] 实现 Token 认证 + Session
- [ ] 创建 Vue 3 项目骨架
- [ ] 实现登录页面

### Phase 2: 核心功能 (3 天)
- [ ] 仪表盘页面
- [ ] API 浏览器 (Swagger-like)
- [ ] 节点配置页面
- [ ] 日志查看器 (WebSocket)

### Phase 3: 拓扑可视化 (2 天)
- [ ] WebSocket 服务
- [ ] 拓扑数据生成
- [ ] ECharts Graph 拓扑图
- [ ] 实时更新 + 动画

### Phase 4: 集成与优化 (1 天)
- [ ] 静态文件嵌入 (go:embed)
- [ ] Makefile 构建脚本
- [ ] README 文档更新

---

## 📝 Admin API 清单

管理界面专用 API（`/admin/api/v1/`）：

### 认证
| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /auth/verify | 验证 Token，返回 Session |
| POST | /auth/logout | 退出登录 |
| GET | /auth/status | 检查认证状态 |

### 节点管理
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /node/info | 节点详细信息 |
| GET | /node/stats | 运行统计数据 |
| POST | /node/restart | 重启节点 |
| POST | /node/stop | 停止节点 |

### 网络拓扑
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /topology | 获取完整拓扑数据 |
| GET | /peers | 连接节点列表 |
| POST | /peers/disconnect | 断开指定节点 |
| POST | /peers/blacklist | 加入黑名单 |

### 配置管理
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /config | 获取当前配置 |
| PUT | /config | 更新配置 |
| POST | /token/refresh | 刷新 Admin Token |

### 日志
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /logs | 获取历史日志 |
| GET | /logs/download | 下载日志文件 |

### HTTP API 文档
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api-docs | 获取 HTTP API 列表 |

### WebSocket
| 路径 | 说明 |
|------|------|
| /ws/topology | 拓扑实时更新 |
| /ws/logs | 日志实时流 |
| /ws/stats | 统计数据流 |

---

## 🔗 相关任务

- **Task 38**: [启动命令改进](task38启动命令改进.md) - 端口参数、Token 命令
- **Task 39**: [SKILL 更新](task39SKILL更新.md) - Agent 安装使用文档