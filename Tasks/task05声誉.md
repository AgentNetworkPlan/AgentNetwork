# 🗂 “轻量共识 + 传播声誉”设计方案

## 1️⃣ BT 网络的启示

BitTorrent 网络本身没有“全局账本”或共识机制，它做的是 **局部信誉和激励**：

1. **Tit-for-Tat（以牙还牙）机制**

   * 交换数据时，优先服务于贡献多的节点
   * 节点只看到自己和直接通信伙伴的行为

2. **局部统计**

   * 节点只维护自己和邻居的上传/下载速度、贡献量
   * 没有全网统一账本
   * 信用是**局部感知**，不是全网一致

3. **隐式激励**

   * 高贡献 → 获得更快下载或优先服务
   * 低贡献 → 限速、拒绝服务

> 核心思想：**信誉和奖励是局部、动态、可验证的，而不是全网一致的账本记录**

---

## 2️⃣ 声誉系统设计

你想要“声誉可以传播”，可以参考社交网络式的 **Web-of-Trust**：

### 2.1 节点声誉表示

* 每个节点有 **NodeID（SM2 公钥）**
* 节点维护本地 **信誉表**：

  ```json
  {
    "NodeID_A": 80,
    "NodeID_B": 50,
    "NodeID_C": 20
  }
  ```
* 信誉分值可量化贡献：

  * 完成任务 → 增加
  * 作假 / 失职 → 减少
  * 节点可设置最小信誉阈值才接受委托

### 2.2 声誉传播机制

* 节点与**可信节点**建立信任关系（线上确认或抵押）
* 当两个节点通信时：

  * **交换各自的信誉表**
  * 只采纳可信节点的推荐
* 声誉传播策略：

  * 权重叠加：来自可信节点的评价比陌生节点的评价更高
  * 信誉值衰减：传播越远，权重越低

### 2.3 声誉更新公式（示例）

假设节点 A 信任节点 B（权重 w_AB），B 给 C 的评价是 r_BC，则 A 对 C 的间接信誉可以计算：

```
r_AC_indirect = w_AB * r_BC
```

* A 自己对 C 的直接观察 r_AC_direct 与间接信誉结合：

```
r_AC = α * r_AC_direct + (1-α) * sum(r_AC_indirects)
```

* α ∈ [0,1] 调节直接经验和间接传播的权重
* 这种方式类似 **Web-of-Trust + 指数衰减**

---

## 3️⃣ 防滥用与 Sybil 攻击

* **节点必须绑定公钥**
* **可信关系建立**：

  * 线下或线上身份确认
  * 可附加抵押（信誉抵押，非货币）
* **传播信誉时仅采纳可信节点的推荐**
* **间接传播衰减** 防止远距离 Sybil 篡改

---

## 4️⃣ 节点本地维护 vs 全局

* **本地维护**：

  * 节点只维护与自己相关的直接和可信间接评价
  * 无需全网账本
* **动态更新**：

  * 每次通信 → 交换信誉表 → 更新本地数据
* **节点离线/上线**：

  * 离线不会破坏全网声誉
  * 上线后可以从可信节点同步更新

---

## 5️⃣ 工程实现建议

### 5.1 数据结构

```go
type Reputation struct {
    NodeID string
    Score  int
    LastUpdated time.Time
    Source map[string]float64 // 谁给的权重
}
type ReputationTable map[string]Reputation
```

### 5.2 更新流程

1. 完成任务 / 被观察到贡献 → 更新直接评分
2. 与可信节点通信 → 交换信誉表
3. 计算间接信誉 → 更新本地表
4. 使用信誉表作为：

   * 任务委托权重
   * Worker 选择优先级
   * 验证委员会选择依据

### 5.3 特点

* **无需全局账本**
* **动态、可传播**
* **激励局部良性行为**
* **容易扩展**：

  * 信誉衰减机制
  * 权重自适应调整
  * 与任务贡献量化结合

---

## 6️⃣ 总结

| 特性    | 说明                   |
| ----- | -------------------- |
| 不需要账本 | 全网不保存完整记录，本地维护即可     |
| 信誉传播  | 可信节点之间交换，间接传播，衰减处理   |
| 防滥用   | 信任建立 + 抵押 + 本地验证     |
| 激励机制  | 高信誉节点更易获得任务，低信誉节点被限制 |
| 可扩展   | 与贡献证明、任务完成量结合        |

> 核心思想：BT 网络的“Tit-for-Tat + 局部统计” + Web-of-Trust 的“可信传播”，无需全局账本，也能维护网络安全和贡献激励。


明白了，你想把 **任务系统 + 声誉系统 + 指责机制**整合成一套可量化节点贡献的机制。我帮你整理成完整设计方案，包括 **任务分配、完成验证、声誉奖励、传播、指责扣减**，让网络能公平激励节点。

---

# 🏗 任务 & 声誉系统设计方案

## 1️⃣ 设计目标

1. **贡献量化**：每个节点完成任务可获得声誉奖励
2. **公平传播**：声誉可通过邻居传播，鼓励协作
3. **不可滥用**：防止伪造任务完成或滥发声誉
4. **作恶惩罚**：指责机制扣除恶意节点声誉
5. **动态更新**：声誉随时间自然衰减，任务完成可增加

---

## 2️⃣ 任务系统设计

### 2.1 任务类型

| 类型    | 说明                  |
| ----- | ------------------- |
| 单节点任务 | 指定节点完成（计算、验证、消息中继等） |
| 多节点任务 | 需要多个节点协作完成，可交叉验证    |
| 中继任务  | 节点负责转发消息/任务给其他节点    |
| 审计任务  | 超级节点或邻居审计网络状态、指责处理  |

### 2.2 任务分配流程

1. **任务创建**：

   * 超级节点或任务发起节点生成任务
   * 包含任务ID、目标节点、内容、截止时间
   * 使用 SM2 签名

```json
{
  "TaskID": "task_12345",
  "CreatorID": "NodeID_X",
  "TargetNodeID": "NodeID_Y",
  "TaskType": "Compute",
  "Content": {...},
  "Deadline": 1670003600,
  "Signature": "SM2签名"
}
```

2. **任务分发**：

   * 通过邻居或直接发送到目标节点
   * 离线节点 → 中继邻居缓存任务

3. **任务提交**：

   * 节点完成任务 → 提交结果
   * 提交结果包含：

     * TaskID、结果摘要、提交时间、节点ID、签名

4. **任务验证**：

   * 单节点任务 → 超级节点或邻居验证结果
   * 多节点任务 → 多节点交叉验证
   * 验证成功 → 触发声誉奖励

---

## 3️⃣ 声誉系统设计

### 3.1 声誉计算

* **基础规则**：

  * 完成任务 → 声誉 + ΔR (依任务复杂度/贡献度)
  * 自然衰减 → 每天 -1 点声誉
  * 指责扣减 → 根据邻居分析扣除一定声誉

* **声誉传播**：

  * 邻居接收到声誉变化 → 根据信任传播
  * 衰减传播 + 耐受值限制
  * 保证声誉传播不会被滥发

```text
Node声誉 = 当前声誉 + 完成任务奖励 - 指责扣减 ± 邻居传播影响 - 自然衰减
```

---

### 3.2 声誉消息结构

```json
{
  "NodeID": "NodeID_Y",
  "DeltaReputation": 3,
  "SourceTaskID": "task_12345",
  "Timestamp": 1670004000,
  "Originator": "NodeID_X", // 发起节点或监督节点
  "Signature": "SM2签名"
}
```

---

## 4️⃣ 指责机制

### 4.1 指责流程

1. 节点 A 发现节点 B 作恶 → 发起指责
2. 指责消息包含：

   * 被指责节点ID
   * 指责理由
   * 发起节点声誉
   * 时间戳 + SM2签名

```json
{
  "AccuserID": "NodeID_A",
  "AccusedID": "NodeID_B",
  "Reason": "未完成任务",
  "Timestamp": 1670005000,
  "Signature": "SM2签名"
}
```

3. 邻居 C 收到指责：

   * 验签 → 验证发起节点声誉
   * 分析指责合理性 → 扣除 B 的声誉
   * 可附加自己意见 → 更新指责消息，签名
   * 传播指责消息（衰减 + 耐受值限制）

### 4.2 指责规则

* 发起指责 → 扣除自己少量声誉（防止滥发）
* 指责传播 → 根据邻居信任传播
* 多邻居投票 → 指责确认 → 扣除作恶节点声誉

---

## 5️⃣ 系统逻辑流程

```
Step 1: 任务创建 → 签名 → 分发
   │
Step 2: 节点完成任务 → 提交结果 → 签名
   │
Step 3: 验证结果
   │
Step 4: 验证通过 → 声誉奖励 → 邻居传播
   │
Step 5: 发现作恶 → 发起指责 → 邻居分析 → 扣除声誉 → 传播
   │
Step 6: 每天自然衰减声誉
```

---

## 6️⃣ 数据结构总结

### 任务 Task

```json
{
  "TaskID": "...",
  "CreatorID": "...",
  "TargetNodeID": "...",
  "TaskType": "...",
  "Content": {...},
  "Deadline": 1670003600,
  "Signature": "..."
}
```

### 声誉 Reputation

```json
{
  "NodeID": "...",
  "DeltaReputation": 3,
  "SourceTaskID": "...",
  "Timestamp": 1670004000,
  "Originator": "...",
  "Signature": "..."
}
```

### 指责 Accuse

```json
{
  "AccuserID": "...",
  "AccusedID": "...",
  "Reason": "...",
  "Timestamp": 1670005000,
  "Signature": "..."
}
```

---

## 7️⃣ 安全与防滥发设计

| 问题       | 解决方法           |
| -------- | -------------- |
| 节点伪造任务完成 | 必须通过邻居/超级节点验证  |
| 滥发声誉     | 耐受值 + 衰减传播     |
| 滥发指责     | 扣除发起者声誉 + 邻居分析 |
| 作恶节点     | 邻居 + 超级节点投票剔除  |
| 消息伪造     | 全部消息 SM2 签名    |

---

## 8️⃣ 总结

* **任务系统** → 定义、分发、提交、验证
* **声誉系统** → 贡献量化、邻居传播、衰减机制
* **指责机制** → 作恶惩罚、邻居分析、传播与衰减
* **所有操作都 SM2 签名** → 不可否认、防篡改
* **结合邻居管理** → 声誉和指责传播效率高，网络健康可维护

---

## 🔗 架构对齐说明 (2026-02-04 v2)

> **参考**: [docs/architecture.md](../docs/architecture.md)
> 
> **核心理念**：Agent 是有记忆和判断力的智能体，声誉机制模拟人类社会的口碑传播

### ✅ 本设计与架构完全一致

| 设计点 | 说明 | 状态 |
|--------|------|:----:|
| **局部信誉表** | 每个Agent维护自己的"印象表"，类似人对他人的主观印象 | ✅ 核心设计 |
| **邻居传播** | 声誉通过可信邻居传播，类似人类社会的口碑 | ✅ 核心设计 |
| **Web-of-Trust** | Agent自主决定信任谁的推荐 | ✅ 核心设计 |
| **时间衰减** | 旧的印象逐渐淡化 | ✅ |
| **SM2签名** | 消息不可否认 | ✅ |

### 📋 设计理念

```
┌─────────────────────────────────────────────────────────────────┐
│                    声誉系统 = 模拟人类社会                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   人类社会：                      Agent社会：                   │
│   ───────────                    ───────────                   │
│   我对张三印象不错               Agent A 对 Agent B 声誉 +5     │
│   李四说张三靠谱                 可信邻居传播 → 我也+3          │
│   时间久了印象淡了               时间衰减                       │
│   每个人印象不同                 局部信誉表，无需全网一致       │
│                                                                 │
│   底层提供：                                                    │
│   - P2P消息传递（让Agent可以交换信誉信息）                      │
│   - SM2签名验证（确保消息真实）                                 │
│   - 轻量账本（记录关键入网/违规事件）                           │
│                                                                 │
│   Agent自主决定：                                               │
│   - 是否相信邻居的推荐？                                        │
│   - 给这个节点多少分？                                          │
│   - 是否传播这个声誉？                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 📁 相关文件

- 现有实现: `internal/reputation/reputation.go`
- 底层支持: `internal/network/messenger.go` (消息传递)
- 可选账本: `internal/ledger/` (关键事件存证)

